"use strict";angular.module("futbolDashboardApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap"]).config(["$routeProvider","$locationProvider",function(a,b){b.hashPrefix(""),a.when("/",{templateUrl:"views/laliga-landing.html",controller:"FootballCtrl",controllerAs:"ctrl"}).otherwise({redirectTo:"/"})}]),angular.module("futbolDashboardApp").service("Events",function(){function a(){shared&&(shared.players&&shared.players.data.all.forEach(function(a){delete a.currentPoints,delete a.rowSelected}),shared.teams&&shared.teams.data.list.forEach(function(a){delete a.currentPoints}))}function b(){return!n.filters.selectedDay.results&&n.filters.selectedDay.week_number<43}function c(a){f.forEach(function(b){b(a)})}function d(a,b){return window.shared&&window.shared.players?a?h[a]?h[a][b?1:0]:Math.floor(_.filter(shared.players.data.all,function(c){return b?!c[a]:c[a]}).length/i*100):h.enabled:0}function e(){n.processing=!0;var b=n.filters.selectedDay,c=b.players&&Object.keys(b.players).length;c?(shared.teams.data.list.forEach(function(a){a.currentPoints=0}),shared.players.data.all.forEach(function(a){void 0===b.players[a.id]?a.currentPoints=-100:a.currentPoints=b.players[a.id],delete a.rowSelected,void 0!==a.currentPoints&&-100!==a.currentPoints&&(_.filter(shared.teams.data.list,function(b){return b.team_badge===a.team_badge})[0].currentPoints+=a.currentPoints)})):a(),m.team||(shared.players.data.list=shared.players.data.all),n.loader.only("customTable_rounds"),shared.rounds.changeSorter(3,null,null,null,shared.rounds),"rounds"===n.currentView&&shared.rounds.onRowClick(shared.rounds.data.list[0],0,shared.rounds),k()}var f=[],g={term:"",observer:{},change:function(a,b){Object.keys(g.observer).forEach(function(c){g.observer[c](null,a,b)})}},h={reqPending:!1,player_stats:[0,100],image30x30:[0,100]},i=593,j={id:"default",name:"Total",week_number:100,players:{}},k=function(a){shared.bench.data.list=[],shared.players.changeSorter(b()?"currentPoints":"points",null,b()?"points":null,a,shared.players),n.loader.only("customTable_players"),shared.teams.changeSorter(b()?"currentPoints":"points",null,b()?"points":null,null,shared.teams),events.match?(n.loader.only("teamPlayers_team1"),n.loader.only("teamPlayers_team2")):n.loader.only("teamPlayers_team")},l=function(a,b,c){return function(b,c){var d,e=!0;return b.players&&"points"===shared.teams.sorting?e=!1:shared.players&&b.points&&"points"===shared.players.sorting&&(e=!1),d=e?void 0===c.currentPoints||c.currentPoints===b.currentPoints?(c.points||c.teamPoints||0)-(b.points||b.teamPoints||0):(void 0===c.currentPoints?c.teamPoints:c.currentPoints)-(void 0===b.currentPoints?b.teamPoints:b.currentPoints):c.points-b.points,d||(d=(c.player_value||c.value||0)-(b.player_value||b.value||0)),d||(d=c.id<b.id),a?!d:d}},m={team:null,team1:null,team2:null,selectedDay:j,cleanPoints:a,resultsDay:j.week_number};window.shared=window.shared||{};var n={cache:null,reload:k,views:f,show:c,match:!1,currentView:"lfp",search:g,filters:m,percent:d,percents:h,isDaySelected:b,changeDay:e,processing:!1,playersDay:[],shared:shared,pointSorter:l,days:[j]};return setInterval(function(){if(window.shared&&window.shared.players){var a=Math.floor(_.filter(shared.players.data.all,function(a){return a.player_stats}).length/i*100);h.player_stats=[a,100-a];var b=Math.floor(_.filter(shared.players.data.all,function(a){return a.image30x30}).length/i*100);h.image30x30=[b,100-b],h.reqPending=_.filter(shared.players.data.all,function(a){return a.reqPending}).length}},6e3),window.events=n,n}),angular.module("futbolDashboardApp").controller("HeaderController",["$scope","$rootScope","$location","Events",function(a,b,c,d){a.HOME="/",a.Events=d,a.clickedBall=!1,setTimeout(function(){a.clickedBall||a.show("lfp")},4e3),a.show=function(b){if(a.clickedBall=!0,"rounds"===b){d.isDaySelected()?(!shared.rounds.data.list||shared.rounds.data.list.length>10)&&(d.filters.resultsDay=d.days[1].week_number,shared.rounds.data.list=shared.rounds.data.hier[d.filters.resultsDay]):100===d.filters.resultsDay&&(d.filters.resultsDay=d.days[1].week_number,d.days[0].name="> Jornada "+(d.filters.resultsDay+1)),d.loader.only("customTable_rounds");var c=shared.rounds.data.list.indexOf(function(a){return"rowSelected"===a[a.length-1]});c>-1?shared.rounds.onRowClick(shared.rounds.data.list[c],c,shared.rounds):shared.rounds.onRowClick(shared.rounds.data.list[0],0,shared.rounds),d.match=!0,d.loader.only("teamPlayers_team1"),d.loader.only("teamPlayers_team2")}else if("lfp"===b){d.match=!1,delete d.filters.team1,delete d.filters.team2;var e=_.filter(shared.teams.data.list,function(a){return a.rowSelected})[0];e&&(d.filters.team=e),shared.players.data.list=d.filters.team?d.filters.team.players:shared.players.data.all,shared.players.changeSorter(d.isDaySelected()?"currentPoints":"points",null,null,null,shared.players),d.loader.only("teamPlayers_team")}b&&(d.currentView=b,d.show(b))},a.changeDay=function(a){if(void 0===a)return 100!==d.filters.selectedDay.week_number?(d.filters.resultsDay=d.filters.selectedDay.week_number-1,d.days[0].name="Total"):"rounds"===d.currentView?(d.loader.only("customTable_rounds"),d.filters.selectedDay=d.days[1],d.filters.resultsDay=d.days[1].week_number,d.days[0].name="> Jornada "+(d.filters.resultsDay+1)):d.filters.resultsDay=100,d.changeDay();if(a&&shared.rounds.data&&shared.rounds.data.hier){if(100===d.filters.selectedDay.week_number?(-1===a?(d.days[0].name="Total",100===d.filters.resultsDay?(d.filters.resultsDay=d.days[1].week_number-1,d.filters.selectedDay=d.days[1]):(d.filters.resultsDay+=a,d.days[1].week_number===d.filters.resultsDay+1?d.filters.selectedDay=d.days[1]:(d.days[0].name="> Jornada "+(d.filters.resultsDay+1),d.filters.selectedDay=d.days[0]))):100===d.filters.resultsDay?d.filters.resultsDay=d.days[1].week_number:shared.rounds.data.hier[d.filters.resultsDay+a]&&(d.filters.resultsDay+=a),d.days[0].name="> Jornada "+(d.filters.resultsDay+1),d.loader.only("customTable_rounds"),"rounds"===d.currentView&&shared.rounds.onRowClick(shared.rounds.data.list[0],0,shared.rounds)):100!==d.filters.resultsDay?d.filters.resultsDay+=a:d.filters.resultsDay=d.days[1].week_number,d.days[1].week_number<d.filters.resultsDay&&(d.filters.selectedDay=d.days[0]),d.filters.resultsDay<0)return void(d.filters.resultsDay=0);if(shared.rounds.data.hier[d.filters.resultsDay]){var b=_.filter(d.days,function(a){return a.week_number===d.filters.resultsDay+1})[0];b?(d.days[0].name="Total",d.filters.selectedDay=b):(d.days[0].name="> Jornada "+(d.filters.resultsDay+1),d.filters.selectedDay=d.days[0]),d.loader.only("customTable_rounds"),d.changeDay()}}},a.isActive=function(a){return a===c.path()},a.setSelectionMode=function(b){return b==a.PATH_PRODUCTION?"single":"multiple"}}]),angular.module("futbolDashboardApp").controller("FootballCtrl",["$q","$scope","$http","Events",function(a,b,c,d){function e(a,d,e){return d&&d[a]?(b.cache[a]||(b.cache[d[a]]=d),void((e||!d.reqPending&&!d.player_stats)&&(d.reqPending=!0,setTimeout(function(){c.get(o.replace("{"+a+"}",d[a]),{headers:b.headers}).then(function(c){var e=c&&c.data&&c.data[a];e&&(b.cache[e]?(_.each(Object.keys(c.data),function(a){return-1===i.indexOf(a)?"object"==typeof b.cache[e][a]&&"object"!=typeof c.data[a]?console.warn("FootballCtrl ignore transform",b.cache[d][a],">",c.data[a]):void(b.cache[e][a]=c.data[a]):void 0}),setTimeout(function(){b.onPlayerTeam(b.cache[e])},0)):(b.cache[e]=c.data,console.warn("[customTable] unkown source id",c.data)),delete d.reqPending)})},800-d.points)))):console.error("fetchPlayer error item",d,a)}function f(a,b,c){if(d.isDaySelected()&&a>-1&&b&&b.players&&c&&c.players){var e,f,g=0,h=0;return b.players.forEach(function(b){e=_.filter(b.player_stats,function(b){return b.week_number===a+1})[0],e&&e.stats&&e.stats.goals&&(g+=e.stats.goals[0]),e&&e.stats&&e.stats.own_goals&&(h+=e.stats.own_goals[0]),f=f||!!e}),c.players.forEach(function(b){e=_.filter(b.player_stats,function(b){return b.week_number===a+1})[0],e&&e.stats&&e.stats.goals&&(h+=e.stats.goals[0]),e&&e.stats&&e.stats.own_goals&&(g+=e.stats.own_goals[0]),f=f||!!e}),f?[g,h]:["-","-"]}return["-","-"]}function g(a,b){return a?b?a.replace("RCD ","").replace("Real ","").replace(" CF","").replace("FC","").replace("Atlético O","O").replace(" de Madrid","").replace("Barcelona","Barça").replace("RC ","").replace("SD ","").replace("CD ","").replace("UD Las P","LasP").replace(" Club","").replace("Deportivo ","").replace("de La Coruña","Deportivo").replace(" de Gijón","").replace(" de Vigo",""):a.replace(" SAD","").replace("Club de Fútbol","CF").replace("Fútbol Club","FC").replace("Reial Club Deportiu","RCD").replace(" de Fútbol","").replace("Sociedad Deportiva","SD").replace("Real Club Deportivo","RCD").replace("Club Deportivo","CD").replace("Club At","At").replace("Unión Deportiva","UD").replace("Real Club","RC").replace("Real Sp","Sp").replace(" de Barcelona","").replace(" Balompié",""):""}function h(a,b){var c=a[6]||a[0],d=a[7]||a[1],e=_.filter(shared.teams.data.list,function(a){return a.short_name===c})[0],h=_.filter(shared.teams.data.list,function(a){return a.short_name===d})[0],i=f(b,e,h);return e&&h?(a[0]=g(e.name,!0),a[1]=e.team_badge,a[2]=i[0],a[3]=i[1],a[4]=h.team_badge,a[5]=g(h.name,!0),c.length<4&&(a[6]=c),void(d.length<4&&(a[7]=d))):console.warn("FootballCtrl team not found",a[0],e,"vs",a[1],h)}window.shared=window.shared||{},b.cache=d.cache={},b.user={},b.teams=[],b.Events=d,b.activeTab="lfp",d.views.push(function(a){a?b.activeTab=a:b.loader.only("footballTeam_players")}),b.headers={"Content-Type":"application/json;charset=UTF-8",Accept:"application/json, text/plain, */*","Cache-Control":"no-cache"};var i=["birth_date","birthplace","updated_at","created_at","position","height","initial_market_value","slug","name","rowSelected"],j="8acbdd65161579e0e2b0085d5f710c66";b.login=function(a){!j||a?(delete b.user.error,delete b.headers.Authorization,c.post("https://api-game.laligafantasymarca.com/api/2/login",JSON.stringify(a),{headers:b.headers}).success(function(a){b.user.logged=!0,b.Bearer=a.token,b.headers.Authorization="Bearer "+b.Bearer,b.leagues=a.teams,b.user.selectedLeague=a.teams[0],b.loader.only("customTable_league",{league:b.user.selectedLeague.league.id}),console.log("laligafantasymarca",a)}).error(function(c){b.user.error=c&&c.message,console.error("Error on login",a,c)})):(b.Bearer=j,b.headers.Authorization="Bearer "+j,setTimeout(b.loader.reload,0))},b.logout=function(){delete b.user.error,delete b.user.logged,delete b.user.email,delete b.user.password,delete b.user.leagues,delete b.user.selectedLeague};var k={},l=!1;d.loader=b.loader={add:function(a,b){k[a]=b},remove:function(a){delete k[a]},removeAll:function(){window.localStorage&&_.each(Object.keys(window.localStorage),function(a){window.localStorage.removeItem(a)}),location=""},only:function(a,b){k[a](b)},reload:function(a){_.each(Object.keys(k),function(b){b!==a&&k[b]()}),setTimeout(function(){d.processing=!1},0)},get:function(a){var b;if(window.localStorage&&window.localStorage[a])try{b=JSON.parse(window.localStorage[a])}catch(c){console.error("get",a,c),b=window.localStorage[a]}return b},save:function(a,c){if(window.localStorage&&-1===navigator.userAgent.toLowerCase().indexOf("safari")){if("players"===a.substring(0,7)){if(l||Object.keys(localStorage).length>10)return;if(c.id){if(_.each(i,function(a){delete c[a]}),!c.image30x30)return console.warn("FootballCtrl save player without image?",c)}else c.data&&c.data.all&&(c=JSON.parse(JSON.stringify(c.data.all)),_.each(c,function(a){_.each(i,function(c){delete a[c],delete b.cache[a.id][c]})}))}window.localStorage.setItem(a,"object"==typeof c?JSON.stringify(c):c)}}};var m=function(a){a.points=0,a.value=0,_.each(a.players,function(b){a.points+=b.points,a.value+=b.player_value})};b.materialize=function(a){a?m(_.filter(b.teams,function(b){return b.team_badge===a})):_.each(b.teams,m),shared.teams.changeSorter(d.isDaySelected()?"currentPoints":"points",null,d.isDaySelected()?"points":null),b.$$phase||b.$apply()};var n=50,o="https://api-game.laligafantasymarca.com/api/1/player/{id}";b.fetchPlayers=function(a,c,d,f){if(!c||c.length<d*n)return b.loader.remove("players"),void b.loader.save("players",shared.players.data.all);var g=c.slice(d*n,d*n+n);g&&g.length&&_.each(g,function(b,c){setTimeout(function(){e(a,b,f)},n*c*10)}),b.consumed||(_.each(c,b.onPlayerTeam),b.consumed=!0),setTimeout(function(){b.fetchPlayers(a,c,d+1,f),b.$$phase&&b.apply()},1e4)},b.setTeams=function(a,c){return c&&c.length?shared.teams.data.list.length<20?setTimeout(function(){b.setTeams(a,c)},1400):void _.each(c,function(a){"object"==typeof a[0]?_.each(a,h):h(a,d.filters.selectedDay.week_number-1)}):void 0},b.roundClick=function(a){if(!d.filters.team1||d.filters.team1.short_name!==a[6]||!d.filters.team2||d.filters.team2.short_name!==a[7]){d.filters.team1=_.filter(shared.teams.data.list,function(b){return b.short_name===a[6]})[0],d.filters.team2=_.filter(shared.teams.data.list,function(b){return b.short_name===a[7]})[0],_.each(shared.rounds.data.list,function(a){"rowSelected"===a[a.length-1]&&a.pop()}),a.push("rowSelected"),delete d.filters.team;var b=_.filter(shared.players.data.all,function(b){return b.team_badge===a[1]||b.team_badge===a[4]});d.reload(b)}},b.teamClick=function(a){var b=_.filter(shared.teams.data.all,function(a){return a.rowSelected})[0];d.match=!1,delete d.filters.team1,delete d.filters.team2,b?b.short_name===a.short_name?(delete d.filters.team,delete a.rowSelected):(d.filters.team=a,delete b.rowSelected):d.filters.team=a;var c;_.each(shared.players.data.all,function(a){delete a.rowSelected,delete a.playerSelected}),shared.bench.data.list=[],d.isDaySelected()?c=_.filter(shared.players.data.all,function(b){return b.team_badge===a.team_badge}):(shared.teams.data.list[0].currentPoints||shared.players.data.list[0].currentPoints)&&d.cleanPoints(),b&&b.short_name===a.short_name||(a.rowSelected=!0),d.reload(c)};var p;b.onPlayerTeam=function(a){if(a){var c=a.team.short_name&&_.filter(b.teams,function(b){return b.short_name===a.team.short_name})[0];!c&&a.team.name?(c={name:g(a.team.name),points:a.points,value:a.player_value,team_badge:a.team_badge,short_name:a.team.short_name,players:[a]},b.teams.push(c)):c&&(c.team_badge||(c.team_badge=a.team_badge),c.name||(c.name=g(a.team.name)),_.filter(c.players,function(b){return b.id===a.id}).length||c.players.push(a)),a.player_stats&&(a.player_stats.sort(function(a,b){return b.week_number-a.week_number}),_.each(a.player_stats,function(b){var c=_.filter(d.days,function(a){return a.week_number===b.week_number})[0];c||(c={id:b.id,name:"Jornada "+b.week_number,week_number:b.week_number,players:{}},d.days.push(c)),c.players[a.id]=b.total_points})),p||(p=!0,setTimeout(function(){p=!1,b.materialize(),b.loader.only("customTable_teams"),d.days.sort(function(a,b){return b.week_number-a.week_number})},3e3))}},b.onPlayerClick=function(a){a.starred=!a.starred,b.starredPlayer=a.starred?a:null},b.onBenchPlayerClick=function(a){console.log("[FootballCtrl] received onBenchPlayerClick",a);var c=_.filter(shared.players.data.list,function(a){return a.playerSelected})[0]||{};delete c.playerSelected,c.replacing?c.replacing!==a.id?b.cache[c.replacing].replaced=a.id:delete b.cache[c.replacing].replaced:a.replaced?(b.cache[a.replaced].replacing=c.id,c.replaced=a.replaced):(a.replacing=c.id,c.replaced=c.replaced||a.id),delete c.replacing,delete a.replaced,delete c.rowSelected,d.filters.team1?(d.loader.only("teamPlayers_team1"),d.loader.only("teamPlayers_team2")):d.loader.only("teamPlayers_team"),a.rowSelected=!0,shared.bench.data.all=[],shared.bench.data.list=[]},b.login()}]),angular.module("futbolDashboardApp").directive("customTable",["$window","$http",function(a,b){return{templateUrl:"views/custom-table.html",restrict:"E",scope:{src:"@",href:"@",sort:"@",focus:"@",shared:"@",primary:"@",second:"@",required:"@",data:"=",loader:"=",sorters:"=",filters:"=",methods:"=",options:"=",headers:"=",searcher:"=",hierarchy:"=",properties:"=",materialize:"=",modelTable:"="},link:function(c,d,e){function f(a){a=a||c.options;var d=window.shared&&window.shared[c.shared]||c.loader&&(c.shared?c.loader.get(c.shared):c.loader.get(c.src));if(c.src){if(d&&d.data&&d.data.all&&d.data.all.length)return h(d);b.get(c.src).then(function(a){a&&a.data&&a.data.length&&(d=a.data,h(a.data))})}else if(c.href&&c.properties){if(a&&_.each(Object.keys(a),function(b){a[b]&&(c.href=c.href.replace("{"+b+"}",a[b]))}),-1!==c.href.indexOf("{"))return;b.get(c.href,{headers:c.headers}).then(function(a){a&&a.data&&a.data.length&&(d=a.data,h(a.data))})}else if(c.data)var e=c.$watch("data",function(){c.data&&(e(),h(c.data))});else var e=c.$watch("modelTable",function(){c.modelTable&&(e(),h(c.modelTable))})}function g(a){return"%"===a.transformer?function(b){return"number"==typeof b[a.attr]?(100*b[a.attr]).toPrecision(4)+"%":void 0}:"number"===a.transformer?function(b){return b[a.attr]?"number"!=typeof b[a.attr]&&Number(b[a.attr])&&(b[a.attr]=Number(b[a.attr])):b[a.attr]=0,b[a.attr]}:"+"===a.transformer?function(b){return a.missing&&b[a.attr]===+a.missing?"-":b[a.attr]>0?"+"+b[a.attr]:b[a.attr]}:"€"===a.transformer?function(b){if(b[a.attr]){var c=Number(b[a.attr]);if(c>1e6)return Math.floor(c/1e5)/10+"M€";if(c>1e3)return Math.floor(c/100)/10+"k€"}return b[a.attr]&&b[a.attr]+"€"}:function(b){return b[a.attr]+a.transformer}}function h(a){function b(a,b){var c;return"object"!=typeof a[b]?c=_.filter(i.data.all,function(c){return c[b]===a[b]}):a.length&&(c=_.filter(i.data.all,function(c){return-1!==a[b].indexOf(c[b])})),c}if(!a)return console.log("[customTable] Error finding model",a,k);if(!a.data&&a.length>-1&&(a={data:a}),!a.data)return console.log("[customTable] Error on data model",a,k);if(c.hierarchy){var d=Object.keys(c.hierarchy)[0];d=c.hierarchy[d][d];var e=(a.data.hier?a.data.hier[d]:a.data[d])||(a.data.length?a.data:a.data.all);a.data={all:e,list:e,hier:a.data.hier||a.data}}else a.data.list||(a.data.all?a.data.list=a.data.all:a.data={all:a.data,list:a.data});c.table=i=a,i.sort=i.sort||c.sort,i.sorters=i.sorters||c.sorters,i.required=i.required||c.required,i.properties=i.properties||c.properties,i.primary=i.primary||c.primary,i.second=i.second||c.second,j=i.primary?i.primary:"id",i.focus=i.focus||c.focus,i.searchFields=i.searchFields||{},i.isObject=function(a){return"object"==typeof a},i.changeSorter=i.changeSorter||c.changeSorter||n,i.sorter=i.sorter||c.sorters&&c.sorters[i.sort]&&c.sorters[i.sort]()||function(a,b){return b[i.sort]===a[i.sort]&&i.second?b[i.second]===a[i.second]?a[j]<b[j]:b[i.second]-a[i.second]:b[i.sort]-a[i.sort]},c.shared&&(window.shared=window.shared||{},window.shared[c.shared]=i),i.search=o,i.onRowClick=l,c.searcher&&(c.searcher.attr=_.filter(i.properties,function(a){return a.searcher})[0].attr,c.searcher.observer[k]=i.search);var e;if(c.filters){var f,h,p=c.filters;_.each(Object.keys(p),function(a){h=p[a]&&p[a][0]&&p[a][1],h&&(p[a][1].length?(e=[],_.each(p[a][1],function(c){p[a][0][c]&&p[a][0][c][a]&&(e=e.concat(b(p[a][0][c],a)))}),e.length||(e=null,h=null)):p[a][0][p[a][1]]?e=b(p[a][0][p[a][1]],a):h=null),f=f||!!h}),f?c.source&&i.data.list&&setTimeout(function(){c.methods.source(i.data.list[0])},0):e=i.data.all}var q=_.filter(i.properties,function(a){return"number"===a.transformer});q.length&&_.each(i.data.list,function(a){_.each(q,function(b){a[b.attr]=Number(a[b.attr])})}),c.methods&&c.methods.fetch&&c.methods.fetch(j,c.hierarchy?i.data.list:i.data.all,0),_.filter(i.properties,function(a){return void 0!==a.sorting}).length?i.sorter&&m(e,i):(_.each(i.properties,function(a){a.transformer&&"function"!=typeof a.transform&&(a.transform=g(a))}),i.sort?i.changeSorter(i.sort,null,!0,e,i):e&&!i.data.hier&&(i.data.list=e),!c.hierarchy&&c.methods&&c.methods.fetch&&c.methods.fetch(j,i.data.list,0)),setTimeout(function(){c.$$phase||c.$apply()},10)}var i,j,k="customTable_"+(c.shared||Date.now()),l=function(b,d,e){if(i=e||i,console.log(k,"rowClick",d,b),i.rowLinkProperty){var f=_.filter(i.properties,function(a){return a.attr==i.rowLinkProperty});f.length&&f[0].transform&&a.open(f[0].transform(b),"_blank")}else i.rowClick&&"function"==typeof i.rowClick&&i.rowClick(b,d);c.methods&&(c.methods.click&&c.methods.click(b),c.methods.fetch&&c.methods.fetch(j,[b],0,!0))},m=function(a,b){return i=b||i,i&&i.data?void(a||i.data.list.length===i.data.all.length?i.data.list=(a||i.data.all).sort(i.sorter):a?i.data.list=a.sort(i.sorter):i.data.list.sort(i.sorter)):console.error(k,"> sortTable > error on model",i)},n=function(a,b,c,d,e){if(i=e||i,i.data&&i.data.list){if(a){if(c){var f=_.filter(i.properties,function(a){return void 0!==a.sorting});if(f.length&&f[0].attr!==a&&f[0].attr!==c)return m(null,i)}i.sorters&&i.sorters[a]?i.sorter=i.sorters[a](b):i.sorter=function(c,d){if("string"==typeof c[a]){if(b){if(c[a]<d[a])return 1;if(c[a]>d[a])return-1}else{if(d[a]<c[a])return 1;if(d[a]>c[a])return-1}return c[a]===d[a]?d[i.sort]-c[i.sort]:0}return c[a]===d[a]?d[i.sort]-c[i.sort]:b?c[a]-d[a]:d[a]-c[a]},_.each(i.properties,function(c){c.attr===a?c.sorting=!b:delete c.sorting}),m(d,i)}else i.sorter&&m(d,i);i.sorting=a}},o=function(a,b,d,e){return i=e||i,!b||b.length<2?void 0:d?h(i):void(c.searcher&&c.searcher.attr?(a=c.searcher.attr,i.data.list=_.filter(i.data.list,function(c){return c[a]&&-1!==c[a].toLowerCase().indexOf(b.toLowerCase())})):i.searchFields[a]&&i.searchFields[a].length>1?i.data.list=_.filter(i.data.list,function(b){return b[a]&&-1!==b[a].toLowerCase().indexOf(i.search[a].toLowerCase())}):i.data.list=i.data.all)};c.loader?c.loader.add(k,f):f()}}}]),angular.module("futbolDashboardApp").directive("footballTeam",["$window","$http","TooltipService",function(a,b,c){return{restrict:"E",scope:{id:"@",half:"@",players:"@",direction:"@",team:"=",cache:"=",fetch:"=",loader:"=",headers:"="},link:function(a,b,d){function e(c){if(!A){if(D=J&&J[a.players]?J[a.players].players:c||events.filters[a.players]&&events.filters[a.players].players||shared.players&&shared.players.data.list||D,!D||!D.length)return console.info("[footballTeam] no players yet",C,D,window.shared),!a.team&&setTimeout(e,2e3);var d=!events.isDaySelected()&&J;D=_.filter(D,function(a){return delete a.playerSelected,d?"ok"===a.player_status&&!a.replacing:!a.replacing}).sort(events.pointSorter()),K=[],I=0,v=p(D,1,1),w=p(D,2,5),x=p(D,3,5),y=p(D,4,3),events.isDaySelected()||(v=o(v),w=o(w),x=o(x),y=o(y)),u(v,w,x,y),u(v,w,x,y),u(v,w,x,y),t(w,x,y),t(w,x,y),t(w,x,y),G=b.width(),H=G*(F?.74:1.5),N=H/(F?10:14);var f=document.getElementById(a.id);if(f&&(f.innerHTML=""),O=d3.select("#"+a.id).append("svg").attr("width","100%").attr("height",H+"px"),200>G)return setTimeout(function(){e(D)},1e3);if(J||events.filters.team){var h=J&&J[a.players]&&J[a.players].team_badge;O.append("image").attr("width",(F?8:10)*N).attr("x",G/2-(F?4:5)*N-5).attr("y",G/(F?10:3.6)).style("opacity",.22).attr("xlink:href",h||events.filters.team.team_badge)}var j=v.concat(w).concat(x).concat(y);z&&z.on("tick",null);var k=O.append("defs").attr("id","imgdefs"),l=n(J?events.filters.team1.players.concat(events.filters.team2.players):j);if(g(O,k,v,".goalkeeper",l),g(O,k,w.reverse(),".defenders",l),g(O,k,x.reverse(),".midfield",l),g(O,k,y.reverse(),".striker",l),z=d3.layout.force().size([G,H]).linkDistance(4.7*N).charge(function(a){return a.position_id}).friction(.1).gravity(.2),z.nodes(j).links(K).start(),I>-50&&(O.append("circle").attr("r",30).attr("cx",G-50).attr("cy",!E&&F?48:76).attr("fill",0===I?"gold":I>0?M:"red").style("opacity",.7),O.append("text").text(I+"p").attr("x",G-50).attr("y",!E&&F?56:84).style("font-size",22).style("fill","white").style("text-anchor","middle").style("font-family","'Oswald', sans-serif")),_.filter(D,function(a){return!a.image250x250}).length)A=!0,setTimeout(function(){A=!1,e()},3e3);else{var m=Date.now();z.on("tick",null),z.on("tick",function(){if(F||Date.now()-m>L){var a=d3.behavior.drag().on("drag",i);return d3.selectAll(".draggable").call(a),z.on("tick",null)}_.each(j,function(a){1!==a.position_id&&(d3.select("#filled_"+a.id).attr("cx",P()(a)).attr("cy",Q()(a)),d3.select("#image_"+a.id).attr("cx",P()(a)).attr("cy",Q()(a)),d3.select("#marker_"+a.id).attr("cx",P(.66*-N)(a)).attr("cy",Q(.66*-N-4)(a)),d3.select("#points_"+a.id).attr("x",P(.66*-N)(a)).attr("y",Q(.66*-N)(a)),d3.select("#back_"+a.id).attr("x",P(-38)(a)).attr("y",Q(N-19)(a)),d3.select("#label_"+a.id).attr("x",P()(a)).attr("y",Q(N-3,a)))})})}}}function f(a){return a.playerSelected?"blue":-100===a.currentPoints?"gold":void 0!==a.currentPoints?0===a.currentPoints?"gold":a.currentPoints>0?M:"red":a.player_status?"ok"===a.player_status?M:"red":"grey"}function g(b,c,d,e,g){var h=[0,H/8+H*(E?.07:.75),H/8+H*(E?.27:F?.54:.58),H/8+H*(E?.52:F?.28:.36),H/8+H*(E?.74:F?.07:.14)];_.each(d,function(a,b){I+=q(a),l(a,b);a.x=G/(d.length+1)*(b+1),a.y=h[+a.position_id],1!==a.position_id&&1!==d.length&&((!F||F&&4===a.position_id)&&3===d.length&&1===b||5===d.length&&0===b||!F&&5===d.length&&2===b||5===d.length&&4===b?2===a.position_id?a.y+=3===d.length||E?N:-N/2:(!F||3!==a.position_id||y.length<3)&&(a.y+=(3===a.position_id&&E?N/2:-N)/2):4!==d.length||0!==b&&3!==b||(a.y+=E?N/2:-N/2)),a.rowSelected=!0;c.append("pattern").attr("id","patt_"+a.id).attr("height",1).attr("width",1).attr("x","0").attr("y","0").append("image").attr("id",a.id).attr("x",0).attr("y",0).attr("xlink:href",(J?a.image96x96:a.image250x250)||"./images/fantasy_no_image.b626e96c.png").style("width",2*N).style("height",2*N)});var i=b.selectAll(e).data(d).enter().append("g").attr("class","draggable").on("click",g).on("dblclick",g).on("mouseover",S).on("mouseout",R);if(i.append("circle").attr("class","filled").attr("id",function(a){return"filled_"+a.id}).attr("r",N-1).attr("cx",P()).attr("cy",Q()).attr("fill","lightgrey"),i.append("circle").attr("class","image").attr("id",function(a){return"image_"+a.id}).attr("r",N).attr("cx",P()).attr("cy",Q()).attr("fill",function(a){return"url(#patt_"+a.id+")"}).attr("stroke",f).style("stroke-width",function(a){return a.playerSelected?"4px":"2px"}).style("cursor","pointer"),i.append("circle").attr("class","marker").attr("id",function(a){return"marker_"+a.id}).attr("r",12).attr("cx",P(.66*-N)).attr("cy",Q(.66*-N-4)).attr("fill",f),i.append("text").attr("class","points").attr("id",function(a){return"points_"+a.id}).attr("x",P(.66*-N)).attr("y",Q(.66*-N)).text(function(a){return-100===a.currentPoints?"-":void 0===a.currentPoints?a.points:a.currentPoints}).style("text-anchor","middle").style("fill","white").style("font-size",11).style("font-family","'Oswald', sans-serif"),i.append("rect").attr("class","back").attr("id",function(a){return"back_"+a.id}).attr("x",P(-38)).attr("y",Q(N-19)).style("fill","white").attr("height",25).attr("width",76).style("stroke","black").style("stroke-width","0.3px").attr("rx",15),i.append("text").attr("class","groupLabel mono axis").attr("id",function(a){return"label_"+a.id}).attr("x",P()).attr("y",Q(N-3)).text(function(a){if(!a.nickname)return"";if(a.nickname.length>12){var b=a.nickname.split(" ");return b.length>1?b[0].length<3?b[1]+" "+b[2]:b[0].charAt(0)+". "+b[1].split("-")[0].substring(0,11):a.nickname.substring(0,12)}return a.nickname}).style("text-anchor","middle").style("fill","black").style("font-size",11),a.fetch){var j=_.filter(d,function(a){return!a.player_stats});j.length&&setTimeout(function(){a.fetch("id",j,0,!0)},1e3)}}function h(a){return function(b){b&&b.stats&&(b.stats.mins_played&&(a.minutes+=b.stats.mins_played[0]),b.stats.goals&&(a.goals+=b.stats.goals[0]),b.stats.goal_assist&&(a.assist+=b.stats.goal_assist[0]),b.stats.red_card&&(a.reds+=b.stats.red_card[0]),b.stats.yellow_card&&(a.yellows+=b.stats.yellow_card[0]),b.stats.second_yellow_card&&(a.yellows+=b.stats.second_yellow_card[0]),b.stats.marca_points&&(a.marca+=b.stats.marca_points[1]),b.stats.poss_lost_all&&(a.possession[0]+=b.stats.poss_lost_all[0]),b.stats.ball_recovery&&(a.possession[1]+=b.stats.ball_recovery[0]))}}function i(a,b){c.hide(),B&&clearTimeout(B),B=setTimeout(function(){B=!1},500),d3.event.x<G&&d3.event.x>0&&d3.event.y<H&&d3.event.y>0&&(a.x=d3.event.x,a.y=d3.event.y,d3.select("#filled_"+a.id).attr("cx",P()(a)).attr("cy",Q()(a)),d3.select("#image_"+a.id).attr("cx",P()(a)).attr("cy",Q()(a)),d3.select("#marker_"+a.id).attr("cx",P(.66*-N)(a)).attr("cy",Q(.66*-N-4)(a)),d3.select("#points_"+a.id).attr("x",P(.66*-N)(a)).attr("y",Q(.66*-N)(a)),d3.select("#back_"+a.id).attr("x",P(-38)(a)).attr("y",Q(N-19)(a)),d3.select("#label_"+a.id).attr("x",P()(a)).attr("y",Q(N-3,a)))}function j(b){var c=[b.position_id];1!==+b.position_id&&(2===+b.position_id&&w.length>3?(x.length<5&&c.push(3),y.length<3&&c.push(4)):3===+b.position_id&&x.length>2?(w.length<5&&c.push(2),y.length<3&&c.push(4)):4===+b.position_id&&y.length>1&&(w.length<5&&c.push(2),x.length<5&&c.push(3)));var d,e=J&&J[a.players]&&J[a.players].team_badge||events.filters.team&&events.filters.team.team_badge;d=J?events.filters.team1.players.concat(events.filters.team2.players):events.filters.team?events.filters.team.players:shared.players.data.list,shared.bench.data.list=_.filter(d,function(a){return(e?a.team_badge===e:!0)&&!a.rowSelected&&c.indexOf(+a.position_id)>-1}),a.$$phase||a.$apply()}function k(a,b,c){_.each(a,function(a,c){a.id!==b.id&&K.push({source:b,target:a})})}function l(a,b){1===a.position_id?k(w,a):2===a.position_id?(k(v,a),k(w,a),k(x,a),k(x,a,b)):3===a.position_id?(k(w,a,b),k(x,a),k(y,a,b),k(y,a,b)):4===a.position_id&&(k(x,a),k(y,a,b))}function m(a){d3.select("#marker_"+a.id).attr("fill",f(a)),d3.select("#image_"+a.id).attr("stroke",f(a)).style("stroke-width",a.playerSelected?"4px":"2px")}function n(a){return function(b){events.isDaySelected()||setTimeout(function(){B&&clearTimeout(B),_.each(a,function(a){a.id===b.id?b.playerSelected?(delete a.playerSelected,m(a),shared.bench.data.list=[]):(a.playerSelected=!0,m(a),setTimeout(function(){j(b)},0)):a.playerSelected&&(delete a.playerSelected,m(a))})},50)}}function o(b){var c=[],d=J?J[a.players]:events.filters.team;return _.each(b,function(b){var e=b.replaced&&a.cache[b.replaced],f=function(a){return a.id===e.id};!e||d&&d.team_badge!==e.team_badge?c.push(b):e.position_id!==b.position_id?2===e.position_id&&-1===w.indexOf(f)?w=[e].concat(w):3===e.position_id&&-1===x.indexOf(f)?x=[e].concat(x):4===e.position_id&&-1===y.indexOf(f)?y=[e].concat(y):c.push(b):-1===c.indexOf(function(a){return a.id===e.id})&&c.push(e)}),c}function p(a,b,c){return c=c||5,_.filter(a,function(a){return Number(a.position_id)===b}).slice(0,c)}function q(a){return void 0===a.currentPoints?a.points:a.currentPoints}function r(b,c){var d=b[b.length-1],e=c[c.length-1],f=q(d.replacing?a.cache[d.replacing]:d)-q(e.replacing?a.cache[e.replacing]:e);return f?f>0?!0:!1:D.indexOf(d.replacing?a.cache[d.replacing]:d)<D.indexOf(e.replacing?a.cache[e.replacing]:e)}function s(b,c){var d=b[0],e=d.replacing&&a.cache[d.replacing];e&&e.position_id!==d.position_id&&-1===c[e.position_id].indexOf(function(a){return a.id===e.id})&&(c[e.position_id].unshift(e),b.shift())}function t(a,b,c){c.length>3&&s(c,[null,null,a,b]),b.length>5&&s(b,[null,null,a,null,c]),a.length>5&&s(c,[null,null,null,b,c])}function u(a,b,c,d){return b.length<4?d.length>1&&r(c,d)?d.pop():c.pop():c.length<3?d.length>1&&r(b,d)?d.pop():b.pop():d.length<2?c.length>2&&r(b,c)?c.pop():b.pop():r(d,c)&&r(d,b)?r(c,b)?b.pop():c.pop():r(c,d)&&r(c,b)?r(b,d)?d.pop():b.pop():r(c,d)?d.pop():c.pop()}var v,w,x,y,z,A,B,C="teamPlayers_"+a.id,D=a.loader&&a.loader.get(C)||[],E=a.direction,F=a.half,G=b.width()||474,H=G*(F?.74:1.5),I=0,J=a.team,K=[],L=1800,M="#1adf37",N=46,O=d3.select("#"+a.id).append("svg").attr("width","100%").attr("height","700px"),P=function(a){return function(b){return b.x+(a||0)}},Q=function(a){return function(b){return b.y+(a||0)}},R=c.hide,S=function(a,b,d){var e=[];if(a.player_stats&&a.player_stats.length){var f={minutes:0,goals:0,assist:0,reds:0,yellows:0,marca:0,possession:[0,0]};events.isDaySelected()?h(f)(_.filter(a.player_stats,function(a){
return a.week_number===events.filters.selectedDay.week_number})[0]):("ok"!==a.player_status&&e.push({key:"Status",value:a.player_status}),_.each(a.player_stats,h(f))),(f.goals||f.assist)&&e.push({key:"Goles - Asistencias",value:f.goals+" - "+f.assist}),(f.yellows||f.reds)&&e.push({key:"Amarillas - Rojas",value:f.yellows+" - "+f.reds}),(f.possession[0]||f.possession[1])&&e.push({key:"Posesiones",value:"-"+f.possession[0]+" +"+f.possession[1]}),f.minutes&&(events.isDaySelected()?e.push({key:"Tiempo jugado",value:f.minutes+"'"}):e.push({key:"Minutos / Partidos",value:(f.minutes/a.player_stats.length).toPrecision(2)+"' / "+100*(a.player_stats.length/(events.days.length-1)).toPrecision(2)+"%"})),e.push({key:"Fantasy",value:f.marca+(events.isDaySelected()?" / "+a.points:"")})}c.show({title:a.nickname,image:a.team_badge,datablocks:e})};a.loader&&a.loader.add(C,e),D.length&&e(D)}}}]),angular.module("futbolDashboardApp").service("TooltipService",function(){var a;this.show=function(b){if(b){a=b.title||b.subtitle;var c=d3.select("#node-tooltip").style("display","block");c.select(".node-tooltip-container").select(".node-tooltip-footer").remove(),c.select(".node-tooltip-data-container").selectAll(".node-tooltip-data-block-header").remove(),c.select(".node-tooltip-data-container").selectAll(".node-tooltip-data-block").remove(),c.select(".node-tooltip-data-container").selectAll(".node-tooltip-data-separator").remove(),c.select(".node-tooltip-viz-container").selectAll("*").remove(),b.width&&(c.select(".node-tooltip-container").style("width",b.width+"px"),c.select(".node-tooltip-title").style("max-width",b.width+"px").style("width",b.width+"px"),c.select(".node-tooltip-subtitle").style("overflow-y","auto").style("max-height","200px")),c.select(".node-tooltip-title").html(b.title||""),c.select(".node-tooltip-image").html(b.image&&'<img src="'+b.image+'" height="28"/>'||""),c.select(".node-tooltip-subtitle").html(b.subtitle||""),b.datablocks&&b.datablocks.length&&b.datablocks.forEach(function(a){a.header&&c.select(".node-tooltip-data-container").append("div").attr("class","node-tooltip-data-block-header").html(a.header);var b=c.select(".node-tooltip-data-container").append("div").attr("class","node-tooltip-data-block");a.color&&b.style("color",a.color),b.append("div").attr("class","node-tooltip-data-name").html(a.key),b.append("div").attr("class","node-tooltip-data-value").html(a.value),c.select(".node-tooltip-data-container").append("div").attr("class","node-tooltip-data-separator")}),c.select(".node-tooltip-data-separator:last-of-type").remove(),b.vizspecs&&vg.embed(".node-tooltip-viz-container",b.vizspecs,function(a,b){}),b.footer&&c.select(".node-tooltip-container").append("div").attr("class","node-tooltip-footer").html(b.footer);var d=c.node().offsetHeight+(b.vizspecs?b.vizspecs.spec.height+60:20);c.style("top",b.center?d3.event.pageY-d/2+"px":d3.event.pageY-d+"px").style("left",b.center?d3.event.pageX-c.node().offsetWidth/2+"px":d3.event.pageX+"px"),b.center&&d3.select("#node-tooltip").on("mouseleave",function(){d3.select(this).style("display","none"),b.mouseLeaveCallback&&"function"==typeof b.mouseLeaveCallback&&b.mouseLeaveCallback()});var e=a,f=this;setTimeout(function(){e===a&&f.hide()},7e3)}},this.hide=function(){a="",d3.select("#node-tooltip").style("display","none")}}),angular.module("futbolDashboardApp").run(["$templateCache",function(a){a.put("views/custom-table.html",'<table ng-show="table.data.list.length" class="table directive-custom-table table-responsive"> <thead> <tr> <th ng-class="prop.classes" ng-switch="prop.control" ng-if="!prop.hidden" ng-repeat="prop in table.properties track by $index"> <span ng-switch-when="undefined">{{ prop.name }}</span> <span ng-switch-when="sort"><span ng-style="{\'margin-left\': prop.nameLeft}">{{ prop.name }}</span> <a ng-if="!prop.sorting && !(prop.missing && table.data.list[0][prop.attr] === undefined)" ng-click="table.changeSorter(prop.attr, false, null, null, table)" ng-style="{\'margin-left\': prop.marginLeft }"> <span class="glyphicon glyphicon-chevron-up"> </span></a> <a ng-if="prop.sorting && !(prop.missing && table.data.list[0][prop.attr] === undefined)" ng-click="table.changeSorter(prop.attr, true, null, null, table)" ng-style="{\'margin-left\': prop.marginLeft }"> <span class="glyphicon glyphicon-chevron-down"> </span></a> </span> <span ng-switch-when="search"><input type="text" ng-name="prop.name" ng-model="table.searchFields[prop.attr]" ng-change="table.search(prop.attr, table)" class="form-control" placeholder="{{ prop.name }}"></span> </th> </tr> </thead> <tbody> <tr no-if="!item.undefined && (!table.required||!!item[table.required])" ng-repeat="item in table.data.list track by (item[table.primary] || item.id || $index)" ng-click="table.onRowClick(item, $index, table)"> <td ng-class="prop.classes" ng-if="!prop.hidden && !table.isObject(item[0])" ng-switch="prop.type" ng-style="{\n              \'color\': prop.textColor ? prop.textColor : (item[prop.attr] > 0 ? prop.options[0] : (item[prop.attr] === 0 ? prop.options[1] : prop.options[2])),\n'+"              'background-color': prop.type==='color' ? (prop.colors ? prop.colors[item[prop.attr]] : item[prop.attr]) : (item[prop.background] || ((item.rowSelected || item[item.length-1]==='rowSelected') ? 'rgba(255, 215, 0, 0.22)' : 'inherit')),\n              'opacity': prop.opacity || (prop.type==='color' ? .8 : 1),\n              'text-align': prop.textAlign || 'left',\n              'font-size': prop.fontSize,\n            }\" ng-repeat=\"prop in table.properties track by $index\"> <span ng-switch-when=\"undefined\">{{ (prop.transform ? prop.transform(item,$index) : item[prop.attr||$index]) }}</span> <span ng-switch-when=\"index\">{{ table.data.list.indexOf(item) + 1 + '.' }}</span> <span ng-switch-when=\"status\"> <span class=\"glyphicon\" ng-if=\"!(prop.exclude && item[prop.exclude] === item[prop.attr||$index])\" ng-style=\"{'color': item.statusColor || item[prop.attr] ? (item[prop.attr] === prop.ok ? (item.starred ? (table.focus ? 'blue' : 'gold') : 'green') : 'red') : 'grey' }\" ng-class=\"{\n              'glyphicon-star': item.starred && !table.focus,\n              'glyphicon-arrow-up': item.starred && table.focus === 'up',\n              'glyphicon-arrow-left': item.starred && table.focus === 'left',\n              'glyphicon-arrow-right': item.starred && table.focus === 'right',\n              'glyphicon-arrow-down': item.starred && table.focus === 'down',\n              'glyphicon-ok': !item.starred && item[prop.attr] === prop.ok,\n              'glyphicon-remove': !item.starred && item[prop.attr] !== prop.ok }\"> </span> <span ng-if=\"prop.exclude && item[prop.exclude] === item[prop.attr||$index]\">{{ prop.then && item[prop.then] }}</span> </span> <span ng-switch-when=\"color\">{{ prop.options ? prop.options[item[prop.attr]] : '' }}</span> <a ng-switch-when=\"link\" href=\"{{ item.url || item[prop.attr||$index] || prop.transform(item,$index) }}\" target=\"_blank\">{{ item[prop.attr||$index] || prop.attr }}</a> <img ng-if=\"!prop.exclude || prop.exclude !== item[prop.attr||$index]\" ng-switch-when=\"image\" height=\"{{ prop.height || '20px' }}\" ng-src=\"{{ item[prop.attr||$index] || prop.undefined || prop.transform(item,$index) }}\" ng-style=\"{'border-radius': prop.border, 'margin-top': prop.top }\"> </td> </tr> </tbody> </table>")}]);